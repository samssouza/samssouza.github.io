<html>
<head>
<meta charset="utf-8">

<script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
	var peer;
	var myStream;
	navigator.getUserMedia = ( navigator.getUserMedia ||
                   navigator.webkitGetUserMedia ||
                   navigator.mozGetUserMedia ||
                   navigator.msGetUserMedia);

	function register() {
		var name = document.getElementById('name').value;

			try {
					peer = new Peer();
					document.getElementById('peer-id').innerHTML = "Peer ID:"+ peer.id;
					navigator.getUserMedia({audio: true}, function(stream) {
							myStream = stream;
							document.getElementById('register').style.display = 'none';
							document.getElementById('userAdd').style.display = 'block';

							peer.on('call', function(call) {
									call.answer(myStream);
									call.on('stream', function(remoteStream) {
											createVideo(remoteStream);
									});
							});

					}, function(err) {
							console.log('Failed to get local stream' ,err);
					});

			} catch (error) {
					console.error(error);
			}
	}

	function addUser(){
			try {
					var name = document.getElementById('add').value;
					document.getElementById('add').value = "";

					var call = peer.call(name, myStream);
					call.on('stream', function(remoteStream) {
							createVideo(remoteStream);
					});
			} catch (error) {
					console.error(error);
			}
	}

	function createVideo(stream) {
			try {
					var container = document.createElement('div');
					var video = document.createElement('video');

					container.appendChild(video);
					document.getElementById('participants').appendChild(container);

					video.autoplay = true;
					video.controls = false;
					video.src = URL.createObjectURL(stream);
			} catch (error) {
					console.error(error);
			}
	}


</script>
</head>
<body>
	<h1 id="peer-id">Peer ID: </h1>
	<div id="register">
		<h1>Your name:</h1>
		<form onsubmit="register(); return false;" accept-charset="UTF-8">
			<input type="text" name="name" value="" id="name" required>
			<input type="submit" name="commit" value="Join!">
		</form>
	</div>
	<div id="userAdd" style="display: none;">
		<h1>Connect with user:</h1>
		<form onsubmit="addUser(); return false;" accept-charset="UTF-8">
			<input type="text" name="name" value="" id="add" required>
			<input type="submit" name="commit" value="Add">
		</form>
	</div>
	<div id="participants"></div>
</body>
</html>